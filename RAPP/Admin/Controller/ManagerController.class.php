<?phpnamespace Admin\Controller;use Admin\Controller;class ManagerController extends RootController{	/**	 *初始化	 *@create 2014-12-13	 *@author zjf	 */	protected function _initialize(){		parent::_initialize();		$this->prefix = C('DB_PREFIX');	}	/**	 *管理员列表	 *@create 2014-12-12	 *@author zjf	 */	public function index(){		$managerlist = D(Manager)->get_item(array(),1);		foreach($managerlist as &$val){			$res = M("auth_group_access")				->join($this->prefix."auth_group ON ".$this->prefix."auth_group.id=".$this->prefix."auth_group_access.group_id")				->where(array('uid'=>$val['id']))				->getField('title',true);			foreach($res as &$va){				$va = '['.$va.']';			}			$val['groups'] = implode(' , ',$res);		}		$this->assign('list',$managerlist);		$this->display();	}	/**	 *新增管理员	 *@create 2014-12-12	 *@author zjf	 */	public function add(){		if(IS_POST){			//dump($_POST);exit();			$res = D('Manager')->add_item($_POST);			if(!$res['status']){				$this->error($res['error']);			}else{				if($_POST['groups']){					foreach($_POST['groups'] as &$val){						$re = D("AuthGroupAccess")->add_item(array('uid'=>$res['status'],'group_id'=>$val));						if(!$re){							$this->error('新增失败！');						}					}				}				$this->redirect('Manager/index',[],1,'新增成功！');			}		}else{			//$grouplist = D('AuthGroup')->get_item(array(),1);			//$this->assign('grouplist',$grouplist);			$this->display();		}	}	/**	 *编辑管理员	 *@create 2014-12-16	 *@author zjf	 */	public function edit(){		if(IS_POST){			//原xuanxiang			/*$groupids = M('AuthGroupAccess')->where(array('uid'=>$_POST['id']))->getField('group_id',true);			foreach($_POST['groups'] as &$val){				if(!in_array($val,$groupids)){					D('AuthGroupAccess')->add_item(array('uid'=>$_POST['id'],'group_id'=>$val));				}			}			foreach($groupids as &$val){				if(!in_array($val,$_POST['groups'])){					D('AuthGroupAccess')->del_item(array('uid'=>$_POST['id'],'group_id'=>$val));				}			}*/			$res = D('Manager')->save_item($_POST);			if($res){                $this->redirect('Manager/index',[],1,'编辑成功！');			}else{				$this->error('编辑失败！');			}		}else{			$page = D('Manager')->get_item(array('id'=>$_GET['id']),0);			/*$res = M('AuthGroupAccess')->where(array('uid'=>$_GET['id']))->getField('group_id',true);			$page['groups'] = implode(',',$res);*/			$this->assign('page',$page);			/*$grouplist = D('AuthGroup')->get_item(array(),1);			$this->assign('grouplist',$grouplist);*/			$this->display();		}	}	/**	 *修改管理员密码	 *@create 2014-12-16	 *@author zjf	 */	public function repass(){		if(IS_POST){		    if($_POST['pass'] != $_POST['repass']){                $this->error('两次密码不一样');            }			$_POST['pass'] = md5($_POST['pass']);			$res = D('Manager')->save_item($_POST);			if(!$res['status']){				$this->error($res['error']);			}else{                $this->redirect('Manager/index',[],1,'密码修改成功！');			}		}else{			$page = D('Manager')->get_item(array('id'=>$_GET['id']),0);			$this->assign('page',$page);			$this->display();		}	}	/**	 *ajax删除管理员	 *@create 2014-12-13	 *@author zjf	 */	public function ajax_del_manager(){		if($_POST['id'] == 1){			$data['status'] = 0;			$data['msg'] = "超级管理员不可被删除！";			$this->ajaxReturn($data);		}else{			$res = M('Manager')->where(array('id'=>$_POST['id']))->delete();			$this->ajaxReturn(array('status'=>$res,'msg'=>'删除失败！'));		}	}}