<?phpnamespace Admin\Controller;use Admin\Controller;class GuestbookController extends RootController{    /**     * 留言列表     * @author zjf ${date}     */	public function index(){		$_GET = I('get.');		$where = array();		//判断uid		if(!empty($_GET['body'])){			$where['body']=array('like','%'.$_GET['body'].'%');		}		//判断动作类型		if(!empty($_GET['phone'])){			$where['phone']=$_GET['phone'];		}		//时间		if($_GET['time_begin'] != ""){//注册时间-begin			$ordertime_begin = strtotime($_GET['time_begin']);		}else{			$ordertime_begin = 0;		}		if($_GET['time_end'] != ""){//注册时间-end			$ordertime_end = strtotime($_GET['time_end'])+24*3600;		}else{			$ordertime_end = time();		}		if(!empty($ordertime_begin) && !empty($ordertime_end)){			$where['created_at'] = array('between',$ordertime_begin.','.$ordertime_end);		}				//判断是否导出-begin		/*if($_GET['expord'] == 'Excel导出'){			$this->export_guestbook($where,array('id'=>'desc'));exit;		}*/		$Guestbook = M('Guestbook');		$count = $Guestbook->where($where)->count();		$Page = getpage($count,15);		$this->assign('pages',$Page->show());		//主数据		$booklist = $Guestbook->where($where)->order('id desc')->limit($Page->firstRow.','.$Page->listRows)->select();		$this->assign('list',$booklist);		$this->display();	}    /**     * 新增     * @author zjf ${date}     */    public function add(){        if(IS_POST){            if($_POST['created_at']){                $_POST['created_at'] = strtotime($_POST['created_at']);            }else{                $_POST['created_at'] = time();            }            if($_POST['response_at']){                $_POST['response_at'] = strtotime($_POST['response_at']);            }else{                unset($_POST['response_at']);            }            $res = M('Guestbook')->add($_POST);            if(!$res){                $this->error('对不起，发布失败！');            }else{                $this->redirect('Guestbook/index',[],1,'发布成功！');            }        }else{            $this->display();        }    }    /**     * 编辑     * @author zjf ${date}     */    public function edit(){        if(IS_POST){            $_POST['created_at'] = strtotime($_POST['created_at']);            if($_POST['response_at']){                $_POST['response_at'] = strtotime($_POST['response_at']);            }else{                if($_POST['response']){                    $_POST['response_at'] = time();                }else{                    unset($_POST['response_at']);                }            }            $res = M('Guestbook')->save($_POST);            if(!$res){                $this->error('编辑失败！');            }else{                $this->redirect('Guestbook/index',[],1,'编辑成功！');            }        }else{            $page = M('Guestbook')->find($_GET['id']);            if(empty($page['response_at'])){                $page['response_at_format'] = '';            }else{                $page['response_at_format'] = date('Y-m-d H:i',$page['response_at']);            }            $this->assign('page',$page);            $this->display();        }    }	/**	 * 留言Excel导出	 */	protected function export_guestbook($where,$order){		$xlsName  = $this->setting['sitename']."留言记录"."(".date('Y-m-d H:i:s',$ordertime_begin)."~".date('Y-m-d H:i:s',$ordertime_end).")";		$xlsCell  = array(			array('id','ID'),			array('uid','用户id'),			array('body','留言内容'),			array('phone','手机号'),			array('add_time','留言时间'),		);		$xlsData  = M('Guestbook')->where($where)->order($order)->select();		foreach($xlsData as &$val){			$val['phone'] = $val['phone'].' ';			$val['add_time'] = $val['add_time']? date('Y-m-d H:i:s',$val['add_time']):"";			};		exportExcel($xlsName,$xlsCell,$xlsData);		exit;	}}