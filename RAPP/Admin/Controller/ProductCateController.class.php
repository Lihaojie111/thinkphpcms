<?phpnamespace Admin\Controller;use Admin\Controller;class ProductCateController extends RootController{	public function index(){	}	public function catelist(){		$catelist = D('ProductCate')->get_cate_list(0);		//dump($catelist);		foreach($catelist as &$val){			$val['total'] = M("Product")->where(array('pid'=>$val['id']))->count();			$val['sort'] = end(explode(',',$val['sort']));		}		$this->assign('catelist',$catelist);		$this->display();	}	/**	 * 添加分类	 */	public function add(){		if(D('ProductCate')->add_cate($_POST['id'],$_POST)){			if($_POST['id'] != 0){				D('ProductCate')->save_item(array('id'=>$_POST['id'],'is_able'=>0));			}			$this->redirect('ProductCate/catelist');		}else{			$this->error('添加失败！');		}	}	/**	 * 保存,显示,编辑分类	 */	public function edit(){		if(IS_POST){			//var_dump($_POST);exit();			$res = M('ProductCate')->save($_POST);			if(!$res){				$this->error('编辑失败！');			}else{				$this->redirect('ProductCate/catelist');			}		}else{			$page = D('ProductCate')->get_self($_GET['id']);			$this->assign('page',$page);			//图片库提取			$where['status'] = 1;			$piclist = M('Picture')->where($where)->field(true)->order('addtime desc')->limit('0,16')->select();			$this->assign('piclist',$piclist);			//附加属性提取			$attr = M('ProductAttr')->where(array('cateid'=>$_GET['id']))->order('sort,id')->select();			$this->assign('attrlist',$attr);			//组件类提取			$widget = C('ATTR_IDENTIFY');			$this->assign('widget',$widget);			$this->display();		}	}	/**	 * 删除一个分类	 * =0(删除失败),=1(删除成功),=2(当前分类下有文章),=3(当前分类有子类)	 */	public function ajax_del_cate(){		//判断是否有内容		$ids = D("ProductCate")->get_child_ids($_POST['id']);		$article = M('Product')->where(array('pid'=>array('in',$ids)))->find();		if($article){			$this->ajaxReturn(array('status'=>0,'error'=>'当前分类或子类下有商品，请删除后进行此操作！'));		}		//获取self、parent		$self = D('ProductCate')->get_self($_POST['id']);		$parent = D('ProductCate')->get_parent($_POST['id']);		//删除分类及下级分类		$res = D('ProductCate')->del_cate($_POST['id']);		if($res){			//删除附加属性			M('ProductAttr')->where(array('cateid'=>$_POST['id']))->delete();			//是否还原父id的is_able属性			$siblings_count = M('ProductCate')->where(array('path'=>$self['path']))->count();			if($siblings_count == 0){				M('ProductCate')->where(array('id'=>$parent['id']))->setField('is_able',1);			}		}		$this->ajaxReturn(array('status'=>1,'ids'=>explode(',',$ids)));	}	/**	 *文章分类新增附加属性	 *@create 2015-2-6	 *@author zjf	 */	public function ajax_add_attr(){		$res = M("ProductAttr")->data($_POST)->add();		if($res){			$data['status'] = 1;			$data['content'] = $_POST;			$data['content']['id'] = $res;		}		$this->ajaxReturn($data);	}	/**	 *ajax设置排序	 *@create 2014-12-16	 *@author zjf	 */	public function ajax_setsort(){		$res = D('ProductCate')->update_sort($_POST['id'],$_POST['sort']);		$this->ajaxReturn($res);	}}