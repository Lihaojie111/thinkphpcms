<?phpnamespace Admin\Controller;use Admin\Controller;class ArticleController extends RootController{	/**	 *新闻列表	 *@create 2014-12-19	 *@author zjf	 */	public function index(){		//载入分类		$this->assign('catelist',D('ArticleCate')->get_cate_list(0));		//分页		$Article = M('Article');		if($_GET['cate_id']){            $where['cate_id'] = $_GET['cate_id'];        }		if($_GET['title']){			$where['title'] = array('like','%'.$_GET['title'].'%');		}		$count = $Article->where($where)->count();		$Page = getpage($count,30);		$show = $Page->show();		//主数据		$alist = $Article->where($where)->field(true)->order('is_stick desc,sort,updated_at desc')->limit($Page->firstRow.','.$Page->listRows)->select();		$catelist = D('ArticleCate')->get_cate_list(0);		foreach($alist as &$val){			foreach($catelist as &$cate){				if($cate['id'] == $val['cate_id']){					$val['cate'] = $cate['name_cn'];				}			}		}		$this->assign('alist',$alist);		$this->assign('pages',$show);		$this->display();		}	/**	 *添加文章	 *@create 2014-12-19	 *@author zjf	 */	public function add(){		if(IS_POST){			$_POST['created_at'] = strtotime($_POST['created_at']);			$_POST['updated_at'] = time();            $_POST['body'] = htmlspecialchars($_POST['body']);			$res = M('Article')->add($_POST);			if(!$res){				$this->error('发布失败');			}else{				$this->redirect('Article/index',array('cate_id'=>$_POST['cate_id']),1,'恭喜你，发布成功！');			}		}else{			//载入分类			$catelist = D('ArticleCate')->get_cate_list(0);//rg_print($catelist);			$this->assign('catelist',$catelist);			$cate_id = I('get.cate_id');            if(empty($cate_id)) {                foreach($catelist as $val){                    if($val['is_able'] == 1){                        $cate_id = $val['id'];                        break;                    }                }            }			$this->assign('cate_id',$cate_id);			//获取附加属性			//$attr = M('ArticleAttr')->where(array('cateid'=>$cate_id))->order('sort,id')->select();			//modified by lf 20160618            if(!$_GET['cate_id']){                $parents_cate = D('ArticleCate')->get_parents($cate_id, 0);                foreach($parents_cate as $val){                    if($val['is_able'] == 1){                        $_GET['cate_id'] = $val['id'];                        break;                    }                }            }			$attr = M('ArticleAttr')->where(array('cateid'=>$_GET['cate_id']))->order('sort,id')->select();			$this->assign('attrlist',$attr);			//图片库提取			$where['status'] = 1;			$piclist = M('Picture')->where($where)->field(true)->order('id desc')->limit('0,4')->select();			$this->assign('piclist',$piclist);			//附加属性			$this->display();		}	}	/**	 *编辑文章	 *@create 2014-12-19	 *@author zjf	 */	public function edit(){		if(IS_POST){            $_POST['created_at'] = strtotime($_POST['created_at']);			$_POST['updated_at'] = time();            $_POST['body'] = htmlspecialchars($_POST['body']);			$res = M('Article')->save($_POST);			if(!$res){				$this->error($res['error']);			}else{				$this->redirect('Article/index',array_decode($_GET['jump_url']),1,'编辑成功！');			}		}else{			//载入分类			$this->assign('catelist',D('ArticleCate')->get_cate_list(0));			$res = D('Article')->get_item(array('id'=>$_GET['id']),0);			$res['extattr'] = json_decode($res['extattr'],true);			$res['body'] = htmlspecialchars_decode($res['body']);			$this->assign('page',$res);			//获取附加属性模型			$attr = M('ArticleAttr')->where(array('cateid'=>$res['cate_id']))->order('sort,id')->select();			//modified by lf 20160618			//rg_print($parents_cate);			//$attr = M('ArticleAttr')->where(array('cateid'=>$parents_cate[0]['id']))->order('sort,id')->select();			//分类图片尺寸            //$this->assign('cate_pic_size', M('ArticleCate')->field('width,height')->find($parents_cate[0]['id']));			//取实际数据字段			$arr = array();			foreach($res['extattr'] as &$val){				array_push($arr,$val['identify']);			}			//将现有值装入模型数组			foreach($attr as $key => &$val){				if(in_array($val['identify'],$arr)){					$val['value'] = $res['extattr'][$key]['value'];				}			}			$this->assign('attrlist',$attr);			//图片库提取			$where['status'] = 1;			$piclist = M('Picture')->where($where)->field(true)->order('addtime desc')->limit('0,4')->select();			$this->assign('piclist',$piclist);			$this->display();		}	}	/**	 *ajax更新文章pid	 *@create 2014-12-19	 *@author zjf	 */	public function ajax_update_pid(){		return D('Article')->save_item(array('id'=>$_POST['id'],'pid'=>$_POST['pid']));	}}