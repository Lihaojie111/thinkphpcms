<?phpnamespace Admin\Controller;use Admin\Controller;class ProductController extends RootController{	public function index(){	}	public function lists(){		//载入分类		$catelist = D('ProductCate')->get_cate_list(0);		$this->assign('catelist',$catelist);		//当前分类id		$_GET['cate_id'] = $_GET['cate_id']?$_GET['cate_id']:0;		$ids = D('ProductCate')->get_child_ids($_GET['cate_id']);		//分页		$Product = M('Product');		$where['pid'] = array('in',$ids);		$count = $Product->where($where)->count();		$Page = new \Think\Page($count,30);		$show = $Page->show();		$this->assign('pages',$show);		//主数据		$alist = $Product->where($where)->field(true)->order('id desc')->limit($Page->firstRow.','.$Page->listRows)->select();		foreach($alist as &$val){			$val['mainpic'] = json_decode($val['mainpic'],true);		}		$this->assign('alist',$alist);		//商品特惠		//特惠		$attach = D('ProductAttach')->get_select_attach();		$this->assign('attach',$attach);		$this->display();	}	public function add(){		if(IS_POST){			unset($_POST['mainpic'][0]);			$_POST['mainpic'] = json_encode($_POST['mainpic']);			$_POST['publish_time'] = NOW_TIME;			$res = D('Product')->add_item($_POST);			if(!$res['status']){				$this->error($res['error']);			}else{				$this->success('恭喜你，发布成功！','Product/goodslist');			}		}else{			//载入分类			$catelist = D('ProductCate')->get_cate_list(0);			$this->assign('catelist',$catelist);			//当前分类			if(empty($_GET['cate_id'])){				foreach($catelist as $val){					if($val['is_able'] == 1){						$_GET['cate_id'] = $val['id'];						break;					}				}			}			//特惠			$attach = D('ProductAttach')->get_select_attach();;			$this->assign('attach',$attach);			//获取附加属性			$attr = M('ProductAttr')->where(array('cateid'=>$_GET['cate_id']))->order('sort,id')->select();			$this->assign('attrlist',$attr);			//图片库提取			$where['status'] = 1;			$piclist = M('Picture')->where($where)->field(true)->order('id desc')->limit('0,16')->select();			$this->assign('piclist',$piclist);			$this->display();		}	}	/*	*修改商品，保存修改	*/	public function edit(){		if(IS_POST){			unset($_POST['mainpic'][0]);			$_POST['mainpic'] = json_encode($_POST['mainpic']);			$res = D('Product')->save_item($_POST);			if(!$res['status']){				$this->error('对不起，编辑失败！');			}else{				$this->redirect('Product/lists',array_decode($_GET['jump_url']),2,'恭喜你，编辑成功！');			}		}else{			//载入分类			$this->assign('catelist',D('ProductCate')->get_cate_list(0));			$res = D('Product')->getRow($_GET['id']);			$res['extattr'] = json_decode($res['extattr'],true);			$res['mainattr'] = json_decode($res['mainattr'],true);			if(empty($res['mainattr'])){				$res['mainattr'] = array(array('name'=>'','value'=>''));			}			$res['mainpic'] = json_decode($res['mainpic'],true);			$this->assign('page',$res);			//特惠			$attach = D('ProductAttach')->get_select_attach();;			$this->assign('attach',$attach);			//获取附加属性模型			$attr = M('ProductAttr')->where(array('cateid'=>$res['pid']))->order('sort,id')->select();			//dump($attr);			//dump($res['extattr']);			//取实际数据字段			$arr = array();			foreach($res['extattr'] as &$val){				array_push($arr,$val['identify']);			}			//将现有值装入模型数组			foreach($attr as $key => &$val){				if(in_array($val['identify'],$arr)){					$val['value'] = $res['extattr'][$key]['value'];				}			}			//dump($attr);			$this->assign('attrlist',$attr);			//图片库提取			$where['status'] = 1;			$piclist = M('Picture')->where($where)->field(true)->order('id desc')->limit('0,16')->select();			$this->assign('piclist',$piclist);			$this->display();		}	}	//ajax更新文章pid	public function ajax_update_pid(){		$res = M('Product')->data(array('id'=>$_POST['id'],'pid'=>$_POST['pid']))->save();		if(false !== $res){			$this->ajaxReturn(array('status'=>1));		}else{			$this->ajaxReturn(array('status'=>0));		}	}	/**	 *ajax删除商品	 *@create 2015-12-16	 *@author zjf	 */	public function ajax_del(){		$res = D('Product')->del_item(array('id'=>$_POST['id']));		$this->ajaxReturn($res);	}	/**	 *ajax生成产品缩略图	 *@create 2015-1-5	 *@author zjf	 */	public function ajax_goods_thumb(){		//获取、处理尺寸		$mid_size = explode(',',$_POST['mid_size']);		$min_size = explode(',',$_POST['min_size']);		$image = new \Think\Image();		$image->open('.'.$_POST['path']);		//将图片裁剪为400x400并保存为corp.jpg		$mid = img_rename("_mid",$_POST['path']);		if(!file_exists('.'.$mid)){			$image->thumb($mid_size[0],$mid_size[1])->save('.'.$mid);		}		$min = img_rename("_min",$_POST['path']);		if(!file_exists('.'.$min)){			$image->thumb($min_size[0],$min_size[1])->save('.'.$min);		}		$this->ajaxReturn(array('status'=>true));	}	/**	 *ajax设置排序	 *@create 2014-12-16	 *@author zjf	 */	public function ajax_setsort(){		$data['id'] = $_POST['id'];		$data['sort'] = $_POST['sort'];		$res = D('Product')->save_item($data);		$this->ajaxReturn($res);	}}